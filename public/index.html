<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Jeditable Edit In Place Demo</title>
<link href="http://www.appelsiini.net/stylesheets/main2.css" rel="stylesheet" type="text/css" />
<script src="http://code.jquery.com/jquery-2.0.3.min.js" type="text/javascript" charset="utf-8"></script>
<script src="http://www.appelsiini.net/download/jquery.jeditable.mini.js" type="text/javascript" charset="utf-8"></script>
<script src="http://cdn.firebase.com/v0/firebase.js"></script>
<script src="http://cdn.firebase.com/v0/firebase-simple-login.js"></script>
<script type="text/javascript" charset="utf-8">


$(function() {
  var username;
  var adRef = new Firebase('https://taehwanjo.firebaseio.com/brochure');
  var userRef;

  var auth = new FirebaseSimpleLogin(adRef, function(error, user) {
    if (error) {
      alert(error);
    } else if (user) {
      $('.loggedin').removeClass('hidden');
      username = user.username;
      console.log(username);

      adRef.child(username).once('value', function(snapshot){
        console.log('adRef CHILD saraloves snapshot val is: ', snapshot.val());
        if (snapshot.val() === null) {
          //create a new user object with blank fields
          //(and then do work);
          adRef.push(username, function(){
            var defaultContent = "Click to edit";
            adRef.child(username).set({coding_insight: defaultContent, core: "Javascript, Backbone.js, Angular.js, Node.js", github: defaultContent, highlights: defaultContent, photo: 0 });
            userRef = adRef.child(username);
            doWork();
          });
        } else {
          userRef = adRef.child(username);
          doWork();
        }
      });


      // if (adRef.child(username).val()) {
      //   console.log('the username ', username, ' exists in firebase');
      // } else {
      //   console.log('shit don\'t exist in firebase');
      // }


      console.log('userRef inside callback is:', userRef);
      
      //doWork();
    } else {
      $('.loggedout').removeClass('hidden');
    }
  });
  //login/logout logic 

  $('.login').on('click', function() {
    $('.loggedout').addClass('hidden');
    auth.login('github', {
      rememberMe: true,
      scope: 'user: email'
    });
  });

  $(".logout").on('click', function(){
    $('.loggedin').addClass('hidden');
    auth.logout();
  });

  console.log(auth);

  // if (adRef.child(photo)) { //obv psueo code
  //   $('#studentpic').attr('src', 'someurlhere');
  //   $('#studentpic').removeClass('hidden');
  // } else {
  //   $('#buttoncontainer').removeClass('hidden');
  // }
  //ajax call asks server if image for this user id 
  //exists

var doWork = function() {
  console.log("userRef is: ", userRef);
  console.log("username is: ", username);
  //console.log(adRef);

//displaying data from database on screen

  $('#buttoncontainer').attr('action', "/upload/" + username);

  userRef.on('value', function(snapshot) {
    var highlights = snapshot.val().highlights;
    var coding_insight = snapshot.val().coding_insight;
    var github = snapshot.val().github;
    var core = snapshot.val().core;
    console.log(snapshot.val().photo);
    //check to see if photo is saved in database, if it is, display, else, display upload button
    if (snapshot.val().photo) {
      $('#studentpic').attr('src', '/imageuploads/' + username);
      $('#studentpic').removeClass('hidden');
      $('#buttoncontainer').addClass('hidden');
    } else {
      $('#studentpic').addClass('hidden');
      $('#buttoncontainer').removeClass('hidden');
    }
    //var photo = snapshot.val().photo;
    $('#github').html(github);
    $('#highlights').html(highlights);
    $('#coding_insight').html(coding_insight);
    $('#core').html(core);
    //$('#photo').html('<img src=' + photo + '></img>');
  });


  $("#highlights").editable("post/"+ username + "/highlights", { 
      indicator : "<img src='img/indicator.gif'>",
      type   : 'textarea',
      submitdata: { _method: "post" },
      select : true,
      submit : 'OK',
      cancel : 'cancel',
      cssclass : "editable"
   });

  $("#coding_insight").editable("post/" + username + "/coding_insight", { 
      indicator : "<img src='img/indicator.gif'>",
      type   : 'textarea',
      submitdata: { _method: "post" },
      select : true,
      submit : 'OK',
      cancel : 'cancel',
      cssclass : "editable"
   });

  $("#github").editable("post/" + username + "/github", { 
      indicator : "<img src='img/indicator.gif'>",
      type   : 'textarea',
      submitdata: { _method: "post" },
      select : true,
      submit : 'OK',
      cancel : 'cancel',
      cssclass : "editable"
   });

  $(":file").change(function(){
    $('#buttoncontainer').append('<input type="submit" class="upload" value="Upload"/>');
  });
};


});



//});
</script>

<style type="text/css">
#sidebar {
  width: 0px;
}

#content {
  width: 770px;
}

.editable input[type=submit] {
  color: #F00;
  font-weight: bold;
}
.editable input[type=button] {
  color: #0F0;
  font-weight: bold;
}

.hidden {
  display:none;
}

#studentpic {
  height: 200px;
}

</style>

</head>

<body>
    <div id="header">
      <p>
        <h1>Student Brochure</h1><br />
      </p>
    </div>
    <div class="loggedout hidden">Login
      <button class="login">Log In</button>
    </div>
      
    <div class="loggedin hidden">

    <h2>I'm so pretty</h2>
    <div>
<!--     Asks for photo if photo doesn't exist, otherwise shows photo -->
      <form action="/upload" id="buttoncontainer" class="hidden" method="post", enctype="multipart/form-data">
      <input type="file" name="displayImage" accept="image/*">
      </form>
      <image id="studentpic" class="hidden"></image>
    <div>

    <h2>Highlights</h2>
    
    <p class="editable_textarea" id="highlights"></p>

     <h2>Coding Insight</h2>
    
    <p class="editable_textarea" id="coding_insight"></p>

    <h2>My Github</h2>
    
    <p class="editable_textarea" id="github"></p>

     <h2>Core Curriculum</h2>
    
    <p class="editable_textarea" id="core"></p>

    <button class="logout">Log Out</button>
    
    </div>

</body>
</html>
